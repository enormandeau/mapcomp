#!/bin/bash

## USAGE : mapcom genome_ref markers mapped_dir figure_dir outfile
## NOTE  : genome_ref and markers are fasta files.
## NOTE  : outfile is a csv file.

set -o errexit
set -o nounset

# Global variables
declare -r GENOME_FILE="${1-02_data/genome/genome.fasta}"
declare -r FASTA_FILE="${2-02_data/markers.fasta}"
declare -r MAPPED_DIR="${3-03_mapped}"
declare -r FIGURE_DIR="${4-04_figures}"
declare -r OUTFILE="${5-05_results/linkage_group_correspondance.csv}"

declare -r PROGDIR=$( readlink -e $( dirname $0 ) )
declare -r bname=$( basename "${FASTA_FILE}" )

# Indexing genome
# bwa index 02_data/genome/genome.fasta

# Test if markers.fasta file exists
no_fasta_file () {
    echo "Missing marker file: ${FASTA_FILE}"
    exit
}
test -s ${FASTA_FILE} || no_fasta_file

# Test if genome.fasta file exists
no_genome_file () {
    echo "Missing genome file: ${GENOME_FILE}"
    exit
}
test -s ${GENOME_FILE} || no_genome_file

# Test if genome is indexed
no_genome_index () {
    echo "Genome is not indexed. Index it with:"
    echo "bwa index 02_data/genome/genome.fasta"
    exit
}
test -s ${GENOME_FILE}.sa || no_genome_index

# Running MapComp
echo "Running MapComp"

# Mapping reads
#   will generate "${FASTA_FILE}".info bname.sam & bname.sorted.bam in MAPPED_DIR
"${PROGDIR}"/01_scripts/01_bwa_align_reads.sh \
    "${GENOME_FILE}" "${FASTA_FILE}" "${MAPPED_DIR}"

# Identify good loci
"${PROGDIR}"/01_scripts/02_filter_bad_loci.sh \
    "${MAPPED_DIR}/$bname.sorted.bam" \
    "${MAPPED_DIR}/wanted_loci.ids"

# Extracting good loci
"${PROGDIR}"/01_scripts/03_extract_good_loci.py \
    "${MAPPED_DIR}/$bname.sam" \
    "${MAPPED_DIR}/wanted_loci.ids" \
    "${MAPPED_DIR}/wanted_loci.sam"

# Extracting best marker pairs
"${PROGDIR}"/01_scripts/04_pair_markers.py \
    "${MAPPED_DIR}/wanted_loci.sam" \
    "${MAPPED_DIR}/wanted_loci.ids" \
    "${MAPPED_DIR}/wanted_loci.info" \
    10000000

# Creating figures
Rscript --vanilla "${PROGDIR}"/01_scripts/05_create_figures.R \
    "${MAPPED_DIR}/wanted_loci.info" \
    "${FASTA_FILE}.info" \
    "$OUTFILE" \
    ${FIGURE_DIR}
